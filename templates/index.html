<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <title>BubuGame üå∑üíñüß∏</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="manifest" href="{{ url_for('manifest') }}?v={{ assetv }}">
  <meta name="theme-color" content="#0f172a">

  <style>
    :root {
      --bg: radial-gradient(circle at top, #0f172a 0%, #020617 55%, #000 100%);
      --tile-size: 62px;
      --radius: 18px;
      --accent: #f472b6;
      --ink: #e2e8f0;

      /* FX toggles (se ajustan en runtime si hace falta) */
      --blur-strength: 6px;              /* se baja a 0px en lite */
      --shadow-tile: 0 8px 16px rgba(0,0,0,.22);
      --shadow-board: 0 20px 45px rgba(0,0,0,.35);
      --ring-color-1: rgba(244,114,182,.55);
      --ring-color-2: rgba(56,189,248,.45);
      --specular-1: rgba(255,255,255,.28);
      --specular-2: rgba(255,255,255,.10);
    }

    *, *::before, *::after { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: var(--bg);
      min-height: 100vh;
      display: grid;
      place-items: center;
      color: var(--ink);
    }

    /* contenedor app */
    .app { width: min(94vw, 460px); }

    /* ====== TOPBAR / HUD ====== */
    .topbar {
      display: flex; justify-content: space-between; align-items: center; gap: .75rem;
      margin-bottom: .85rem;
      background: radial-gradient(circle, rgba(244,114,182,0.2), rgba(15,23,42,.35));
      border: 1px solid rgba(244,114,182,.45);
      border-radius: 18px;
      padding: .7rem 1rem;
      backdrop-filter: blur(12px);
      box-shadow: 0 18px 40px rgba(244,114,182,.15);
    }
    .title-block h1 { font-size: 1.15rem; margin: 0; }
    .title-block small { font-size: .7rem; opacity: .75; }
    .hud { display: flex; gap: .35rem; align-items: center; flex-wrap: wrap; }

    .score-box, .level-box {
      background: rgba(2,6,23,.3);
      border: 1px solid rgba(148,163,184,.2);
      border-radius: 9999px;
      padding: .25rem .7rem;
      font-weight: 600; font-size: .7rem; white-space: nowrap;
    }

    .level-pop { animation: levelPulse .46s ease-out; }
    @keyframes levelPulse { 0%{transform:scale(1);} 40%{transform:scale(1.08);} 100%{transform:scale(1);} }

    .btn-ghost {
      background: rgba(248,113,113,.12);
      border: 1px solid rgba(248,113,113,.35);
      border-radius: 999px;
      padding: .25rem .75rem;
      font-size: .7rem;
      color: #fecaca;
      text-decoration: none;
      transition: .12s ease-out;
    }
    .btn-ghost:hover { background: rgba(248,113,113,.25); }

    /* ====== TABLERO ====== */
    .board {
      width: min(calc(var(--tile-size) * 8 + 20px), 92vw);
      aspect-ratio: 1 / 1;
      display: grid;
      grid-template-columns: repeat(8, 1fr);
      gap: 7px;
      background: radial-gradient(circle, rgba(15,23,42,.2), rgba(15,23,42,.05));
      border: 1px solid rgba(148, 163, 184, 0.2);
      border-radius: 24px;
      padding: 10px;
      position: relative;
      overflow: hidden;
      box-shadow: var(--shadow-board), inset 0 1px 0 rgba(255,255,255,.05);
      /* no tilt continuo = m√°s suave y nunca ‚Äúenchueca‚Äù */
    }

    .board::before,
    .board::after {
      content: "";
      position: absolute;
      inset: -30% -30%;
      background: radial-gradient(circle, rgba(244,114,182,.07), transparent 60%);
      filter: blur(60px);
      pointer-events: none;
      /* se ven sutiles y no animan permanentemente */
    }

    /* Pulso solo cuando hay combo (t√∫ agregas/quitas la clase en JS) */
    .board.combo {
      box-shadow:
        0 26px 60px rgba(244,114,182,.22),
        var(--shadow-board),
        inset 0 0 120px rgba(56,189,248,.10);
      animation: boardPulse .45s ease-out;
    }
    @keyframes boardPulse {
      0% { transform: scale(1.005); }
      100% { transform: scale(1); }
    }

    /* ====== TILE ====== */
    .tile {
      position: relative;
      aspect-ratio: 1 / 1;
      border-radius: 18px;
      background: linear-gradient(180deg, rgba(255,255,255,.05), rgba(15, 23, 42, 0.5));
      border: 1px solid rgba(255, 255, 255, 0.06);
      cursor: grab;
      display: grid;
      place-items: center;
      font-weight: 700;
      font-size: clamp(1.2rem, 3.5vw, 1.6rem);
      color: #ffffff;
      transition: transform .1s ease-out, box-shadow .1s ease-out, filter .1s ease-out;
      user-select: none;
      backdrop-filter: blur(var(--blur-strength));
      box-shadow: var(--shadow-tile);
      touch-action: none;
      transform: translateZ(0);
      contain: layout paint style; /* a√≠sla repaints */
      will-change: transform;
    }

    /* bisel + specular ligero */
    .tile::before,
    .tile::after {
      content: "";
      position: absolute; inset: 0;
      border-radius: inherit;
      pointer-events: none;
    }
    .tile::before {
      background:
        linear-gradient(145deg, rgba(255,255,255,.06), transparent 35%, transparent 65%, rgba(0,0,0,.22));
      mix-blend-mode: overlay;
    }
    .tile::after {
      background:
        radial-gradient(120px 60px at 20% 0%, var(--specular-1), transparent 60%),
        radial-gradient(90px 50px at 80% 100%, var(--specular-2), transparent 60%);
      opacity: 0;
      transition: opacity .14s ease;
    }

    .tile:active { transform: scale(.96); filter: contrast(1.05) saturate(1.05); }
    .tile:hover  { transform: scale(1.02); }
    .tile:hover::after { opacity: .75; }

    .tile.is-dragging {
      transform: scale(1.055);
      box-shadow: 0 16px 40px rgba(244,114,182,.35);
      z-index: 10;
    }

    /* ====== FONDOS POR CANDY ====== */
    .b-0 { background: radial-gradient(circle, #f9731640, #0f172a55); }
    .b-1 { background: radial-gradient(circle, #0ea5e940, #0f172a55); }
    .b-2 { background: radial-gradient(circle, #a855f740, #0f172a55); }
    .b-3 { background: radial-gradient(circle, #f43f5e40, #0f172a55); }
    .b-4 { background: radial-gradient(circle, #22c55e40, #0f172a55); }
    .b-5 { background: radial-gradient(circle, #facc1540, #0f172a55); }

    /* ====== ANIMS ====== */
    @keyframes pop-out {
      0% { transform: scale(1); opacity: 1; }
      70% { transform: scale(1.26); opacity: .75; }
      100% { transform: scale(.15); opacity: 0; }
    }
    .tile.boom {
      animation: pop-out .22s ease-out forwards, tileFlash .22s ease-out;
      will-change: transform, opacity, filter;
    }
    @keyframes tileFlash { 0%{ filter: brightness(1.5) } 100%{ filter: brightness(1) } }

    @keyframes fall-in {
      from { transform: translateY(-12px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }
    .tile.fall { animation: fall-in .18s ease-out; will-change: transform, opacity; }

    /* shock ring solo al boom (no constante) */
    .tile.boom::after {
      content:""; position:absolute; inset:-3px; border-radius:inherit;
      box-shadow: 0 0 0 0 var(--ring-color-1), 0 0 0 0 var(--ring-color-2);
      animation: ring .28s ease-out forwards;
      opacity: 1;
    }
    @keyframes ring {
      to { box-shadow: 0 0 0 10px rgba(244,114,182,0), 0 0 0 18px rgba(56,189,248,0); }
    }

    /* ====== OVERLAYS ====== */
    .celebrate {
      position: fixed;
      inset: 0;
      background: radial-gradient(circle, rgba(15,23,42,.35), rgba(2,6,23,.8));
      display: grid;
      place-items: center;
      z-index: 99;
      pointer-events: none;
      transition: opacity .2s ease-out;
    }
    .celebrate.hidden { opacity: 0; visibility: hidden; }
    .celebrate-box {
      background: rgba(2,6,23,.7);
      border: 1px solid rgba(248,113,113,.45);
      border-radius: 24px;
      padding: 1.2rem 1.5rem;
      text-align: center;
      backdrop-filter: blur(8px);
      animation: celebrate-pop .38s ease-out;
      box-shadow: 0 14px 45px rgba(244,114,182,.35);
    }
    @keyframes celebrate-pop { from { transform: scale(.88); opacity: 0; } to { transform: scale(1); opacity: 1; } }

    .level-toast {
      position: fixed; top: 14px; right: 14px; z-index: 120; transition: .2s ease-out;
    }
    .level-toast.hidden { opacity: 0; transform: translateY(-10px); pointer-events: none; }
    .level-toast-body {
      background: radial-gradient(circle, rgba(244,114,182,.9), rgba(244,114,182,.5));
      border-radius: 999px; padding: .4rem .9rem; color: #0f172a; font-weight: 600;
      box-shadow: 0 14px 45px rgba(244,114,182,.35);
    }

    /* ====== FOOTER ====== */
    .footer-links {
      margin-top: 1rem; display: flex; gap: .7rem; align-items: center; justify-content: space-between; font-size: .75rem;
    }
    .footer-links a { color: #38bdf8; text-decoration: none; }
    .footer-links .mini { opacity: .6; }

    /* ====== M√ìVIL CHICO ====== */
    @media (max-width: 420px) {
      :root { --tile-size: 50px; }
      .topbar { flex-direction: column; align-items: flex-start; }
      .board { gap: 4px; padding: 6px; }
      .tile { border-radius: 14px; }
    }

    /* ====== REDUCIR MOVIMIENTO ====== */
    @media (prefers-reduced-motion: reduce) {
      .tile, .tile.boom, .tile.fall {
        animation-duration: .01ms !important;
        animation-iteration-count: 1 !important;
        transition-duration: .01ms !important;
      }
    }

    /* ====== BOT√ìN DE AYUDA ====== */
    .btn-help {
      width: 28px; height: 28px; border-radius: 999px;
      border: 1px solid rgba(248,113,113,.4);
      background: rgba(248,113,113,.12);
      color: #ffe4e6; font-weight: 700; font-size: .7rem;
      display: grid; place-items: center; cursor: pointer; transition: .12s ease-out;
    }
    .btn-help:hover { background: rgba(248,113,113,.25); }

    /* ====== MODAL INSTRUCCIONES ====== */
    .modal {
      position: fixed; inset: 0; z-index: 200; display: grid; place-items: center;
      transition: opacity .18s ease-out, visibility .18s ease-out;
    }
    .modal.hidden { opacity: 0; visibility: hidden; pointer-events: none; }
    .modal-backdrop {
      position: absolute; inset: 0; background: rgba(2,6,23,.75); backdrop-filter: blur(3px);
    }
    .modal-body {
      position: relative; width: min(92vw, 420px);
      background: radial-gradient(circle, rgba(15,23,42,.8), rgba(2,6,23,.85));
      border: 1px solid rgba(248,113,113,.35);
      border-radius: 18px;
      padding: 1.2rem 1.3rem 1.1rem;
      box-shadow: 0 18px 50px rgba(0,0,0,.35);
      animation: modal-pop .22s ease-out;
    }
    @keyframes modal-pop { from { transform: translateY(10px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
    .modal-body h2 { margin-top: 0; font-size: 1.05rem; margin-bottom: .55rem; }
    .modal-body p { margin: .35rem 0; font-size: .8rem; line-height: 1.35; }
    .modal-close {
      position: absolute; top: 9px; right: 9px; width: 28px; height: 28px; border-radius: 999px;
      border: 1px solid rgba(248,113,113,.4);
      background: rgba(248,113,113,.12); color: #ffe4e6;
      display: grid; place-items: center; cursor: pointer;
    }
    .btn-primary {
      width: 100%;
      background: linear-gradient(120deg, #f472b6, #f97316);
      border: none; border-radius: 999px;
      padding: .55rem 1rem; color: #fff; font-weight: 600; font-size: .75rem; margin-top: .75rem; cursor: pointer; text-align: center;
    }

    @media (max-width: 460px) {
      .modal-body { width: min(100vw, 480px); margin: 0 1rem; }
    }

    /* ====== ‚ÄúFX LITE‚Äù (autom√°tico si el equipo es modesto) ====== */
    .fx-lite .topbar { backdrop-filter: none; }
    .fx-lite .tile { backdrop-filter: none; --blur-strength: 0px; --shadow-tile: 0 6px 10px rgba(0,0,0,.18); }
    .fx-lite .board { --shadow-board: 0 14px 28px rgba(0,0,0,.28); }
    .fx-lite .celebrate-box { backdrop-filter: none; }
  </style>

  <!-- Favicon / Iconos -->
  <link rel="icon" type="image/x-icon" href="{{ url_for('static', filename='favicon.ico') }}?v={{ assetv }}">
  <link rel="icon" type="image/png" href="{{ url_for('static', filename='logo.png') }}?v={{ assetv }}">
  <link rel="apple-touch-icon" href="{{ url_for('static', filename='logo.png') }}?v={{ assetv }}">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
</head>
<body>
  <!-- overlay de festejo -->
  <div id="celebrate" class="celebrate hidden">
    <div class="celebrate-box confetti">
      <div class="celebrate-title">Combo bubucita üíñ</div>
      <div class="celebrate-sub">+ puntos felicidades bubucita üå∑üíñüß∏</div>
    </div>
  </div>

  <!-- toast de nivel -->
  <div id="level-toast" class="level-toast hidden">
    <div class="level-toast-body" id="level-toast-text">Nivel 1 üíó</div>
  </div>

  <div class="app" id="app">
    <div class="topbar">
      <div class="title-block">
        <h1>BubuGame</h1>
        <small>Hola, {{ username }}</small>
      </div>
      <div class="hud">
        <div class="score-box">Puntos: <span id="score">{{ current_score }}</span></div>
        <div class="level-box" id="level-box">Nivel: <span id="level">{{ current_level }}</span></div>
        <div class="score-box">Mejor: <span id="best">{{ best_score }}</span></div>

        <button id="openHelp" class="btn-help" type="button" aria-label="Instrucciones">?</button>
        <a href="{{ url_for('logout') }}" class="btn-ghost">Salir</a>
      </div>
    </div>

    <div id="board" class="board">
      <!-- JS llena el tablero -->
    </div>

    <div class="footer-links">
      {% if leaderboard_url %}
        <a href="{{ leaderboard_url }}">üèÜ Ver ranking</a>
      {% else %}
        <span style="opacity:.4;">üèÜ Ranking no disponible</span>
      {% endif %}
      <span class="mini">BubuGame üíó</span>
      <button id="installBtn" class="btn-install" style="display:none;">üì≤ Instalar</button>
    </div>
  </div>

  <!-- ===== MODAL DE INSTRUCCIONES ===== -->
  <div id="helpModal" class="modal hidden" aria-hidden="true">
    <div class="modal-backdrop" data-close="true"></div>
    <div class="modal-body" role="dialog" aria-modal="true" aria-labelledby="modal-title">
      <button class="modal-close" type="button" data-close="true" aria-label="Cerrar">‚úï</button>
      <h2 id="modal-title">¬øC√≥mo jugar? üíñ</h2>
      <p>1. Arrastra una fichita para intercambiarla con la de al lado (arriba/abajo/izq/der).</p>
      <p>2. Si formas <strong>3 o m√°s iguales</strong> en l√≠nea, desaparecen y ganas puntos.</p>
      <p>3. Si haces 4 o m√°s juntas, hay <strong>combo bubucita</strong> ‚ú®</p>
      <p>4. Sube de nivel juntando puntos. Tu mejor puntaje se guarda.</p>
      <p style="opacity:.65;font-size:.8rem;">Tip: en cel, toca y desliza suave üíó</p>
      <button type="button" class="btn-primary" data-close="true">¬°Listo, a jugar! üß∏</button>
    </div>
  </div>
  <!-- ===== /MODAL ===== -->

  <!-- audios opcionales -->
  <audio id="sfx-match" src="" preload="auto"></audio>
  <audio id="sfx-invalid" src="" preload="auto"></audio>
  <audio id="sfx-level" src="" preload="auto"></audio>

  <script>
    // ===== Service Worker con versi√≥n =====
    const APP_VERSION = "{{ assetv }}";

    if ("serviceWorker" in navigator) {
      (async () => {
        try {
          const reg = await navigator.serviceWorker.register(`/service-worker.js?v=${APP_VERSION}`);
          reg.update();

          if (reg.waiting) reg.waiting.postMessage({ type: 'SKIP_WAITING' });

          let refreshing = false;
          navigator.serviceWorker.addEventListener('controllerchange', () => {
            if (refreshing) return;
            refreshing = true;
            location.reload();
          });

          reg.addEventListener('updatefound', () => {
            const nw = reg.installing;
            nw?.addEventListener('statechange', () => {
              if (nw.state === 'installed' && navigator.serviceWorker.controller) {
                nw.postMessage({ type: 'SKIP_WAITING' });
              }
            });
          });
        } catch (e) {
          console.log('SW reg error', e);
        }
      })();
    }

    // ===== Instalaci√≥n PWA =====
    let deferredPrompt = null;
    const installBtn = document.getElementById("installBtn");

    window.addEventListener("beforeinstallprompt", (e) => {
      e.preventDefault();
      deferredPrompt = e;
      installBtn.style.display = "inline-flex";
    });

    installBtn?.addEventListener("click", async () => {
      if (!deferredPrompt) return;
      deferredPrompt.prompt();
      const { outcome } = await deferredPrompt.userChoice;
      if (outcome === "accepted") installBtn.textContent = "‚úÖ Instalado";
      deferredPrompt = null;
    });

    window.addEventListener("appinstalled", () => {
      if (installBtn) installBtn.textContent = "‚úÖ Instalado";
    });

    // ===== Modal instrucciones =====
    const openHelp = document.getElementById("openHelp");
    const helpModal = document.getElementById("helpModal");

    function openModal() {
      helpModal?.classList.remove("hidden");
      helpModal?.setAttribute("aria-hidden", "false");
    }
    function closeModal() {
      helpModal?.classList.add("hidden");
      helpModal?.setAttribute("aria-hidden", "true");
    }

    openHelp?.addEventListener("click", openModal);
    helpModal?.addEventListener("click", (e) => {
      if (e.target.dataset.close === "true") closeModal();
    });
    window.addEventListener("keydown", (e) => {
      if (e.key === "Escape") closeModal();
    });

    // ===== FX Lite autom√°tico si el equipo es modesto =====
    (function performanceGuard(){
      try {
        const app = document.getElementById('app');
        const lowCores = navigator.hardwareConcurrency && navigator.hardwareConcurrency <= 4;
        const lowMem = navigator.deviceMemory && navigator.deviceMemory <= 4;
        const smallScreen = Math.min(window.innerWidth, window.innerHeight) <= 480;
        const reduceMotion = window.matchMedia('(prefers-reduced-motion: reduce)').matches;

        if (reduceMotion || (lowCores && (lowMem || smallScreen))) {
          app?.classList.add('fx-lite');
        }
      } catch(e){}
    })();

    // ===== Hook visual: cuando detectes combo 4+ en tu game.js llama esto =====
    function flashBoardCombo(){
      const board = document.getElementById('board');
      board?.classList.add('combo');
      setTimeout(()=> board?.classList.remove('combo'), 450);
    }
    // window.flashBoardCombo = flashBoardCombo; // descomenta si lo quieres global

    // // Mostrar la primera vez (opcional)
    // openModal();
  </script>

  <!-- tu juego -->
  <script src="{{ url_for('static', filename='game.js') }}?v={{ assetv }}"></script>
</body>
</html>
