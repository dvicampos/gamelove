<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>BubuGame ğŸ’–</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="icon" type="image/png" href="{{ url_for('static', filename='logo.png') }}">
  <link rel="apple-touch-icon" href="{{ url_for('static', filename='logo.png') }}">
  <link rel="manifest" href="/manifest.json" />
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}" />
  <script>
    if ("serviceWorker" in navigator) {
      navigator.serviceWorker.register("/service-worker.js");
    }
  </script>
</head>
<body>
  <div class="app">
    <header class="topbar">
      <div class="title-block">
        <h1>BubuGame ğŸ’–</h1>
        <small>Hola, {{ username }}</small>
      </div>
      <div class="hud">
        <!-- nivel y puntaje que VIENEN de Flask -->
        <div class="level-box" id="level-box">
          Nivel: <span id="level">{{ current_level or 1 }}</span>
        </div>
        <div class="score-box">
          Puntos: <span id="score">{{ current_score or 0 }}</span>
        </div>
        <div class="score-box soft">
          Mejor: <span id="best">{{ best_score or 0 }}</span>
        </div>
        <a href="{{ url_for('logout') }}" class="btn-ghost">Salir</a>
      </div>
    </header>

    <main class="game-wrap">
      <div id="board" class="board" aria-label="Tablero de dulces"></div>
    </main>

    <footer class="footer-links">
      <a href="{{ url_for('leaderboard') }}">ğŸ† Ver ranking</a>
      <span class="mini">BubuGameğŸ’—</span>
      <button id="btn-install" class="btn-install" style="display:none;">
        ğŸ“² Instalar
      </button>
    </footer>
    <div id="ios-hint" class="ios-hint" style="display:none;">
      ğŸ“± Para instalar en iPhone: toca <strong>Compartir</strong> â†’ <strong>â€œAÃ±adir a inicioâ€</strong>
    </div>
  </div>

  <!-- overlay de festejo -->
  <div id="celebrate" class="celebrate hidden">
    <div class="celebrate-box">
      <p class="celebrate-title">Â¡Combo hermoso! âœ¨</p>
      <p class="celebrate-sub">Eres la mejor mi bubucita ğŸ’•</p>
    </div>
    <div class="confetti"></div>
  </div>

  <!-- toast de nivel -->
  <div id="level-toast" class="level-toast hidden">
    <div class="level-toast-body">
      <span id="level-toast-text">Nivel 2 ğŸ’—</span>
    </div>
  </div>

  <!-- audios (ponlos en static/sounds) -->
  <audio id="sfx-match" src="{{ url_for('static', filename='sounds/match.mp3') }}" preload="auto"></audio>
  <audio id="sfx-invalid" src="{{ url_for('static', filename='sounds/invalid.mp3') }}" preload="auto"></audio>
  <audio id="sfx-level" src="{{ url_for('static', filename='sounds/level.mp3') }}" preload="auto"></audio>
  <script>
    // guardaremos el evento para lanzarlo cuando el user toque el botÃ³n
    let deferredPrompt = null;
    const btnInstall = document.getElementById("btn-install");
    const iosHint = document.getElementById("ios-hint");

    // detectar iOS + Safari (muy bÃ¡sico pero sirve)
    const isIos = /iphone|ipad|ipod/i.test(window.navigator.userAgent);
    const isInStandalone = window.matchMedia("(display-mode: standalone)").matches || window.navigator.standalone === true;

    // 1) iOS: no hay prompt, mostramos instrucciÃ³n
    if (isIos && !isInStandalone) {
      if (iosHint) {
        iosHint.style.display = "block";
      }
    }

    // 2) Android / desktop compatible
    window.addEventListener("beforeinstallprompt", (e) => {
      // no muestres el prompt automÃ¡tico
      e.preventDefault();
      deferredPrompt = e;
      // mostramos el botÃ³n
      if (btnInstall) {
        btnInstall.style.display = "inline-flex";
      }
    });

    if (btnInstall) {
      btnInstall.addEventListener("click", async () => {
        if (!deferredPrompt) {
          // no hay evento todavÃ­a
          return;
        }
        // muestra el prompt
        deferredPrompt.prompt();
        // espera respuesta del usuario
        const { outcome } = await deferredPrompt.userChoice;
        // console.log("User choice:", outcome);
        // ya no se puede usar de nuevo
        deferredPrompt = null;
        // ocultar botÃ³n si quieres
        btnInstall.style.display = "none";
      });
    }
  </script>

  <script src="{{ url_for('static', filename='game.js') }}"></script>
</body>
</html>
